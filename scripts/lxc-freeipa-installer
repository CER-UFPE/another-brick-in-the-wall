#!/bin/bash

cat <<"EOF"
# ██████╗███████╗██████╗       ██╗   ██╗███████╗██████╗ ███████╗
# ██╔════╝██╔════╝██╔══██╗      ██║   ██║██╔════╝██╔══██╗██╔════╝
# ██║     █████╗  ██████╔╝█████╗██║   ██║█████╗  ██████╔╝█████╗  
# ██║     ██╔══╝  ██╔══██╗╚════╝██║   ██║██╔══╝  ██╔═══╝ ██╔══╝  
# ╚██████╗███████╗██║  ██║      ╚██████╔╝██║     ██║     ███████╗
#  ╚═════╝╚══════╝╚═╝  ╚═╝       ╚═════╝ ╚═╝     ╚═╝     ╚══════╝ 
EOF

# ----------------------------
# CONFIGURAÇÕES MANUAIS
# ----------------------------

read -p "Digite o hostname completo (ex: node01.cer.ufpe.br): " HOSTNAME_FULL
read -p "Digite o domínio (ex: cer.ufpe.br): " DOMINIO
read -p "Digite o servidor FreeIPA (ex: ipa.cer.ufpe.br): " SERVIDOR_IPA

# Realm derivado do domínio (em maiúsculo)
REALM=$(echo "$DOMINIO" | tr '[:lower:]' '[:upper:]')

# Coleta segura das credenciais FreeIPA
echo ""
read -p "Digite o usuário admin do FreeIPA: " USUARIO_ADMIN
read -s -p "Digite a senha do usuário '$USUARIO_ADMIN': " SENHA_ADMIN
echo ""

# Instalar dependências necessárias
echo "==> Instalando cliente FreeIPA e Kerberos..."
dnf install -y freeipa-client krb5-workstation sssd oddjob-mkhomedir

# Configurar hostname
echo "==> Configurando hostname..."
hostnamectl set-hostname "$HOSTNAME_FULL"

# Remover instalação antiga do FreeIPA (se houver)
ipa-client-install --uninstall -U || true

# Ingressar no domínio FreeIPA
echo "==> Ingressando no FreeIPA..."
echo "$SENHA_ADMIN" | ipa-client-install \
    --hostname="$HOSTNAME_FULL" \
    --mkhomedir \
    --enable-dns-updates \
    --domain="$DOMINIO" \
    --server="$SERVIDOR_IPA" \
    --principal="$USUARIO_ADMIN" \
    --password="$SENHA_ADMIN" \
    --unattended

echo ""
echo "✅ Máquina $HOSTNAME_FULL ingressou no FreeIPA com sucesso!"
echo "⚠️ Lembre-se de adicionar manualmente no host: $HOSTNAME_FULL $DOMINIO"
