#!/bin/bash
# ==============================================
# Script de configura√ß√£o autom√°tica da Infiniband no Proxmox VE
# Reposit√≥rio: CER-UFPE/another-brick-in-the-wall
# ==============================================

cat <<"EOF"
# ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó       ‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
# ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó      ‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
# ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó  
# ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ïö‚ïê‚ïê‚ïê‚ïê‚ïù‚ñà‚ñà‚ïë   ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïù ‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù  
# ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë      ‚ïö‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ïë     ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó
#  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù       ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù 
EOF

echo "===== Configura√ß√£o Autom√°tica de Infiniband ====="

# Passo 1 ‚Äî Atualizar o sistema e instalar pacotes
echo "[1/7] Atualizando sistema e instalando pacotes..."
apt update
apt install -y infiniband-diags ibutils rdmacm-utils libmlx4-1 libmlx5-1 libibverbs1 ibverbs-utils

# Passo 2 ‚Äî Carregar m√≥dulo IPoIB
echo "[2/7] Carregando m√≥dulo ib_ipoib..."
modprobe ib_ipoib

# Passo 3 ‚Äî Verificar interface Infiniband
echo "[3/7] Detectando interface Infiniband..."
IB_IFACE=$(ip -o link show | awk -F': ' '/ibp/{print $2; exit}')

if [ -z "$IB_IFACE" ]; then
    echo "Nenhuma interface Infiniband encontrada!"
    exit 1
fi

echo "Interface detectada: $IB_IFACE"
echo
echo "ibv_devinfo:"
ibv_devinfo
echo
ip a

# Passo 4 ‚Äî Usu√°rio tem que informar o IP
read -p "Digite o IP para a interface Infiniband (apenas o numero final "192.168.1.x" ex: 5): " IP_END

# Monta o endere√ßo IP completo
IP_FULL="192.168.1.$IP_END"

echo "[4/7] Configurando interface $IB_IFACE com IP $IP_FULL..."

# Editar /etc/network/interfaces
cat <<EOF >> /etc/network/interfaces

auto $IB_IFACE
iface $IB_IFACE inet static
    address $IP_FULL/24
    mtu 65507
    pre-up echo connected > /sys/class/net/$IB_IFACE/mode
EOF

echo "Interface adicionada ao /etc/network/interfaces."

# Passo 5 ‚Äî Aplicar altera√ß√µes
echo "[5/7] Reiniciando interface..."
ifdown $IB_IFACE 2>/dev/null
ifup $IB_IFACE

# Passo 6 ‚Äî Carregar m√≥dulos automaticamente
echo "[6/7] Adicionando m√≥dulos ao /etc/modules..."
echo "mlx4_ib" >> /etc/modules
echo "ib_ipoib" >> /etc/modules

# Passo 7 ‚Äî Testar comunica√ß√£o
echo "[7/7] Testando comunica√ß√£o com coiote1"
ping -c 4 150.161.56.10

echo ""
echo "============================================="
echo " ‚úÖ Configura√ß√£o conclu√≠da com sucesso! "
echo "============================================="
echo ""
echo " üü¢ A interface Infiniband foi configurada e adicionada ao arquivo:"
echo "     /etc/network/interfaces"
echo ""
echo " üü¢ Os m√≥dulos necess√°rios foram carregados e configurados para subir"
echo "     automaticamente em todos os reboots:"
echo "        - mlx4_ib"
echo "        - ib_ipoib"
echo ""
echo " ‚úÖ A interface configurada foi: $IB_IFACE"
echo " ‚úÖ Endere√ßo aplicado: $IP_FULL"
echo ""
echo " ‚ö†Ô∏è Aten√ß√£o!"
echo " Voc√™ ainda precisa adicionar MANUALMENTE a seguinte linha a todos os "HOSTS":"
echo ""
echo "     $IP_FULL coiote$NODE_NUM.cer.ufpe.br coiote$NODE_NUM"
echo ""
echo " Ap√≥s isso, sua Infiniband estar√° totalmente pronta para uso. üöÄ"
echo ""
echo "============================================="
