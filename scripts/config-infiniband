#!/bin/bash
# ==============================================
# Script de configuração automática da Infiniband no Proxmox VE
# Repositório: CER-UFPE/another-brick-in-the-wall
# ==============================================

cat <<"EOF"
# ██████╗███████╗██████╗       ██╗   ██╗███████╗██████╗ ███████╗
# ██╔════╝██╔════╝██╔══██╗      ██║   ██║██╔════╝██╔══██╗██╔════╝
# ██║     █████╗  ██████╔╝█████╗██║   ██║█████╗  ██████╔╝█████╗  
# ██║     ██╔══╝  ██╔══██╗╚════╝██║   ██║██╔══╝  ██╔═══╝ ██╔══╝  
# ╚██████╗███████╗██║  ██║      ╚██████╔╝██║     ██║     ███████╗
#  ╚═════╝╚══════╝╚═╝  ╚═╝       ╚═════╝ ╚═╝     ╚═╝     ╚══════╝ 
EOF

echo "=============================================="
echo " CONFIGURAÇÃO AUTOMÁTICA DE INFINIBAND PROXMOX"
echo "=============================================="
sleep 1

### PASSO 0 — Perguntas ao usuário ###
read -p "Digite o endereço IP para atribuir à interface Infiniband (ex: 192.168.1.10): " IP_ADDR
read -p "Digite o hostname/FQDN a ser adicionado no /etc/hosts (ex: node1.cluster.intra): " HOST_FQDN
read -p "Digite o IP de teste (ping) do outro nó: " TEST_IP

### PASSO 1 — Atualizar sistema e instalar pacotes IB ###
echo "[1/7] Instalando pacotes InfiniBand..."
apt update -y
apt install -y infiniband-diags ibutils rdmacm-utils libmlx4-1 libmlx5-1 libibverbs1 ibverbs-utils

### PASSO 2 — Carregar módulo IPoIB ###
echo "[2/7] Carregando módulo ib_ipoib..."
modprobe ib_ipoib
echo "✅ Módulo carregado."



### PASSO 3 — Detectar automaticamente a interface IB ###
echo "[3/7] Detectando interface Infiniband..."

# Primeira tentativa: interfaces que começam com "ib"
IB_IFACE=$(ls /sys/class/net | grep -E "^ib" | head -n 1)

if [ -z "$IB_IFACE" ]; then
    # Segunda tentativa: procurar "mlx5" / "ipoib"
    IB_IFACE=$(ip -o link show | grep -E "mlx5|ipoib" | awk -F': ' '{print $2}' | head -n 1)
fi

if [ -z "$IB_IFACE" ]; then
    echo "❌ Nenhuma interface Infiniband detectada!"
    exit 1
fi

echo "✅ Interface Infiniband detectada: $IB_IFACE"
sleep 1


### PASSO 4 — Criar interface no /etc/network/interfaces ###
echo "[4/7] Configurando interface $IB_IFACE no /etc/network/interfaces ..."

cp /etc/network/interfaces /etc/network/interfaces.bak_$(date +%F_%H-%M)

cat <<EOF >> /etc/network/interfaces

# --- Interface Infiniband configurada automaticamente ---
auto $IB_IFACE
iface $IB_IFACE inet static
    address $IP_ADDR/24
    mtu 65507
    pre-up echo connected > /sys/class/net/$IB_IFACE/mode
# --------------------------------------------------------
EOF

echo "✅ Interface adicionada ao /etc/network/interfaces."


### PASSO 5 — Aplicar alterações ###
echo "[5/7] Reiniciando interface $IB_IFACE..."
ifdown $IB_IFACE 2>/dev/null
ifup $IB_IFACE


### PASSO 6 — Testar comunicação ###
echo "[6/7] Testando ping para $TEST_IP ..."
pin
